const DOC_ID = "1ShP2zZIZUfer-NK6bPcRl2UIDy32VWDsxuGQ-G63VWo"; // Google Doc ID
const FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSe4UKsEzqou6HVoimdeEwzSZx2SG-7E8tG4zMgLyhSCsHpvMw/viewform"; // Google Form URL
const SHEET_ID = "1GmoHt2NeSayd5nTXL4pIoNWo3S4Vbp4SGlRKy5bwEno"; // Leave/Liberty Tracker Sheet ID

let currentSessionID = null; // Store the current session ID

// Generate a new QR code and update the Google Doc
function generateAndInsertQRCode() {
  const doc = DocumentApp.openById(DOC_ID);
  const body = doc.getBody();

  // Generate a new session ID
  currentSessionID = Utilities.getUuid();

  // Embed the session ID in the Google Form URL
  const qrURL = `${FORM_BASE_URL}?usp=pp_url&sessionID=${encodeURIComponent(currentSessionID)}`;

  // Generate the QR code URL
  const qrCodeImageURL = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrURL)}`;

  // Clear existing content and insert the new QR code
  body.clear();
  body.appendParagraph("Scan this QR code to check out:");
  body.appendImage(UrlFetchApp.fetch(qrCodeImageURL).getBlob());
  body.appendParagraph(`Session ID: ${currentSessionID}`);

  doc.saveAndClose();
}

// Log a scan, refresh the QR code, and invalidate the old session
function logScanAndRefresh(request) {
  if (!request || !request.parameter) {
    return ContentService.createTextOutput("Invalid request: Missing parameters.");
  }

  const scannedSessionID = request.parameter.sessionID; // Session ID from form submission
  const studentID = request.parameter.studentID; // Student ID from form submission

  // Validate that both parameters are provided
  if (!scannedSessionID || !studentID) {
    return ContentService.createTextOutput("Invalid request: Missing sessionID or studentID.");
  }

  // Validate the session ID
  if (scannedSessionID !== currentSessionID) {
    return ContentService.createTextOutput("Invalid or Expired QR Code");
  }

  // Log the valid scan
  logToSheet(studentID, scannedSessionID);

  // Invalidate the current session and generate a new QR code
  generateAndInsertQRCode();

  return ContentService.createTextOutput("Check-out Successful");
}

// Log the valid check-out in the Google Sheet
function logToSheet(studentID, sessionID) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName("Sheet 1"); // Replace "Sheet 1" with your tab name
  sheet.appendRow([new Date(), studentID, sessionID]);
}

// Deployable Web App Endpoint
function doGet(request) {
  return logScanAndRefresh(request);
}
